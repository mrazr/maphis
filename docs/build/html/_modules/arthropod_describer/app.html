<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>arthropod_describer.app &mdash; MAPHIS 0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> MAPHIS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">arthropod_describer</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MAPHIS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>arthropod_describer.app</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for arthropod_describer.app</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">importlib.resources</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">urllib.error</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">PySide2</span>
<span class="kn">from</span> <span class="nn">PySide2.QtCore</span> <span class="kn">import</span> <span class="n">QModelIndex</span><span class="p">,</span> <span class="n">QPoint</span><span class="p">,</span> <span class="n">QItemSelectionModel</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">QItemSelection</span><span class="p">,</span> <span class="n">QObject</span>
<span class="kn">from</span> <span class="nn">PySide2.QtGui</span> <span class="kn">import</span> <span class="n">QCloseEvent</span><span class="p">,</span> <span class="n">QPixmap</span><span class="p">,</span> <span class="n">QColor</span><span class="p">,</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QImage</span><span class="p">,</span> <span class="n">QIcon</span><span class="p">,</span> <span class="n">QCursor</span>
<span class="kn">from</span> <span class="nn">PySide2.QtWidgets</span> <span class="kn">import</span> <span class="n">QMainWindow</span><span class="p">,</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="p">,</span> <span class="n">QMenu</span><span class="p">,</span> <span class="n">QAction</span><span class="p">,</span> \
    <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QDockWidget</span><span class="p">,</span> <span class="n">QListView</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QDialogButtonBox</span><span class="p">,</span> <span class="n">QAbstractItemView</span>

<span class="kn">from</span> <span class="nn">arthropod_describer.common.blocking_operation</span> <span class="kn">import</span> <span class="n">BlockingOperation</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.edit_command_executor</span> <span class="kn">import</span> <span class="n">EditCommandExecutor</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.image_operation_binding</span> <span class="kn">import</span> <span class="n">ImageOperation</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.label_change</span> <span class="kn">import</span> <span class="n">generate_change_command</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.label_hierarchy</span> <span class="kn">import</span> <span class="n">LabelHierarchy</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.local_storage</span> <span class="kn">import</span> <span class="n">Storage</span><span class="p">,</span> <span class="n">LocalStorage</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.photo</span> <span class="kn">import</span> <span class="n">LabelImg</span><span class="p">,</span> <span class="n">Photo</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.plugin</span> <span class="kn">import</span> <span class="n">RegionComputation</span><span class="p">,</span> <span class="n">GeneralAction</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.scale_setting_widget</span> <span class="kn">import</span> <span class="n">ScaleSettingWidget</span><span class="p">,</span> <span class="n">ScaleItemDelegate</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.state</span> <span class="kn">import</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.tool</span> <span class="kn">import</span> <span class="n">Tool</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.user_params</span> <span class="kn">import</span> <span class="n">UserParamWidgetBinding</span><span class="p">,</span> \
    <span class="n">create_params_widget_with_buttons</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.common.utils</span> <span class="kn">import</span> <span class="n">choose_folder</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.image_list_delegate</span> <span class="kn">import</span> <span class="n">ImageListDelegate</span><span class="p">,</span> <span class="n">ImageListView</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.image_list_model</span> <span class="kn">import</span> <span class="n">ImageListModel</span><span class="p">,</span> <span class="n">ImageListSortFilterProxyModel</span><span class="p">,</span> <span class="n">ROLE_IMAGE_NAME</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.image_viewer</span> <span class="kn">import</span> <span class="n">ImageViewer</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.import_dialog</span> <span class="kn">import</span> <span class="n">ImportDialog</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.import_utils</span> <span class="kn">import</span> <span class="n">TempStorage</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.label_editor.label_editor</span> <span class="kn">import</span> <span class="n">LabelEditor</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.measurements_viewer.measurements_viewer</span> <span class="kn">import</span> <span class="n">MeasurementsViewer</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.plugin_manager</span> <span class="kn">import</span> <span class="n">PluginManager</span><span class="p">,</span> <span class="n">ProcessType</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.tag_filter_widget</span> <span class="kn">import</span> <span class="n">TagFilterWidget</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.tags_widget</span> <span class="kn">import</span> <span class="n">TagsWidget</span><span class="p">,</span> <span class="n">PhotoTagsWidget</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.thumbnail_gui</span> <span class="kn">import</span> <span class="n">ThumbGUI</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.thumbnail_storage</span> <span class="kn">import</span> <span class="n">ThumbnailStorage_</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.tools.ruler</span> <span class="kn">import</span> <span class="n">Tool_Ruler</span>
<span class="kn">from</span> <span class="nn">arthropod_describer.ui_arthropod_describer</span> <span class="kn">import</span> <span class="n">Ui_ArhtropodDescriber</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;arthropod_logger.log&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(filename)-30s</span><span class="s2"> </span><span class="si">%(levelname)-8s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ArthropodDescriber&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="run_reg_comp_on_storage"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.run_reg_comp_on_storage">[docs]</a><span class="k">def</span> <span class="nf">run_reg_comp_on_storage</span><span class="p">(</span><span class="n">reg_comp</span><span class="p">:</span> <span class="n">RegionComputation</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">Storage</span><span class="p">,</span> <span class="n">progress_queue</span><span class="p">:</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span> <span class="n">send_photo</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">storage</span><span class="o">.</span><span class="n">image_count</span><span class="p">):</span>
        <span class="n">photo</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_idx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">label_imgs</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">LabelImg</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_comp</span><span class="p">(</span><span class="n">photo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">send_photo</span><span class="p">:</span>
            <span class="n">progress_queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">storage</span><span class="o">.</span><span class="n">image_count</span><span class="p">,</span> <span class="n">photo</span><span class="p">,</span> <span class="n">label_imgs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">progress_queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">storage</span><span class="o">.</span><span class="n">image_count</span><span class="p">))</span></div>


<div class="viewcode-block" id="ArthropodDescriber"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber">[docs]</a><span class="k">class</span> <span class="nc">ArthropodDescriber</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
    <span class="n">copying_finished</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">QMainWindow</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">app</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AA_DisableWindowContextHelpButton</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="n">Ui_ArhtropodDescriber</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">setupUi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_version_checking</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">label_img_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_label_image_changed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">Tool</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_tools</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label_info_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_color_pixmap</span> <span class="o">=</span> <span class="n">QPixmap</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_color_pixmap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">QColor</span><span class="o">.</span><span class="n">fromRgb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_color_icon</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_color_icon</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_color_pixmap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_label</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_idx</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">QModelIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">ThumbnailStorage_</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plugins_widget</span> <span class="o">=</span> <span class="n">PluginManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins_widget</span><span class="o">.</span><span class="n">apply_region_computation</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_regions3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_plugins_menu_entry</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">measurements_viewer</span> <span class="o">=</span> <span class="n">MeasurementsViewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurements_viewer</span><span class="o">.</span><span class="n">open_project_folder</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_project_folder_in_explorer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurements_viewer</span><span class="o">.</span><span class="n">unsaved_changes</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_actionSave</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">tabMeasurements</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QVBoxLayout</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">tabMeasurements</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">measurements_viewer</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">command_executor</span><span class="p">:</span> <span class="n">EditCommandExecutor</span> <span class="o">=</span> <span class="n">EditCommandExecutor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_executor</span><span class="o">.</span><span class="n">label_image_modified</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_applyToUnsegmented_state</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span> <span class="o">=</span> <span class="n">LabelEditor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionUndo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionRedo</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">command_executor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_label_editor</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_label_info_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span> <span class="o">=</span> <span class="n">ImageListModel</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span> <span class="o">=</span> <span class="n">ImageListSortFilterProxyModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">setSourceModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">setSortCaseSensitivity</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">CaseSensitivity</span><span class="o">.</span><span class="n">CaseInsensitive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">setSortRole</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">setDynamicSortFilter</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SortOrder</span><span class="o">.</span><span class="n">AscendingOrder</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_image_list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Storage</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionOpenProject</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_action_open_project_triggered</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">import_dialog</span> <span class="o">=</span> <span class="n">ImportDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_dialog</span><span class="o">.</span><span class="n">open_project</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_project</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_dialog</span><span class="o">.</span><span class="n">import_photos</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">include_photos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionImportPhotos</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_action_import_photos_triggered</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionCreateProject</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">import_dialog</span><span class="o">.</span><span class="n">open_for_creating_project</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_dialog</span><span class="o">.</span><span class="n">set_label_image_assignments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;label_image_assignments&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionRecentlyOpened</span><span class="o">.</span><span class="n">setMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_recently_opened_menu</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionExit</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_application</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionSave</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_project</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label_hierarchies</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_default_label_hierarchies</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">tabWidget</span><span class="o">.</span><span class="n">currentChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_tab_changed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_dock_widgets</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_op</span><span class="p">:</span> <span class="n">ImageOperation</span> <span class="o">=</span> <span class="n">ImageOperation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_op</span><span class="o">.</span><span class="n">photo_rotated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_image_op_photo_rotated</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_op</span><span class="o">.</span><span class="n">photo_resized</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_image_op_photo_resized</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_op</span><span class="o">.</span><span class="n">operation_running</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_highlight_photo_in_image_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_op</span><span class="o">.</span><span class="n">operation_finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">highlight_indexes</span><span class="p">([]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_scale_setting_widget</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale_thumbnail_delegate</span> <span class="o">=</span> <span class="n">ScaleItemDelegate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_image_viewer</span><span class="p">:</span> <span class="n">ImageViewer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_index</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">QModelIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TagsWidget</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># QObject.connect(QApplication.instance(), PySide2.QtCore.SIGNAL(&quot;focusChanged(QWidget *, QWidget *)&quot;), self.handle_focus_changed)</span>
        <span class="n">QObject</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">(),</span> <span class="n">PySide2</span><span class="o">.</span><span class="n">QtCore</span><span class="o">.</span><span class="n">SIGNAL</span><span class="p">(</span><span class="s2">&quot;focusChanged(QWidget *, QWidget *)&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_focus_changed</span><span class="p">)</span>

<div class="viewcode-block" id="ArthropodDescriber.handle_focus_changed"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_focus_changed">[docs]</a>    <span class="k">def</span> <span class="nf">handle_focus_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">:</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">new</span><span class="p">:</span> <span class="n">QWidget</span><span class="p">):</span>
        <span class="c1"># print(&quot;calling app.py:focus changed&quot;)</span>
        <span class="c1"># if old == self.image_list:</span>
        <span class="c1">#     self.close_photo_tags_widget()</span>
        <span class="k">if</span> <span class="n">new</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_photo_tags_widget</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tag_filter_widget</span><span class="o">.</span><span class="n">tags_widget</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_setup_scale_setting_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="p">:</span> <span class="n">ScaleSettingWidget</span> <span class="o">=</span> <span class="n">ScaleSettingWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_scales_accepted</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">cancelled</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">switch_to_label_editor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">first_photo_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_first_photo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">last_photo_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_last_photo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">next_photo_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_next_photo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">prev_photo_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_prev_photo</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_plugins_menu_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins_menu</span> <span class="o">=</span> <span class="n">QMenu</span><span class="p">(</span><span class="s1">&#39;Plugins&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuBar</span><span class="p">()</span><span class="o">.</span><span class="n">insertMenu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menuBar</span><span class="p">()</span><span class="o">.</span><span class="n">actions</span><span class="p">()[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menuBar</span><span class="p">()</span><span class="o">.</span><span class="n">actions</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins_menu</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins_widget</span><span class="o">.</span><span class="n">plugins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">general_action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plugin</span><span class="o">.</span><span class="n">general_actions</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plugins_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">general_action</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">action</span><span class="p">:</span> <span class="n">QAction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins_menu</span><span class="o">.</span><span class="n">actions</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">action</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">general_action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins_menu</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute_general_action_or_show_settings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins_menu</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_dock_widgets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dw_image_list</span> <span class="o">=</span> <span class="n">QDockWidget</span><span class="p">()</span>
        <span class="n">lay_</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">lay_</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">lblTagFilter</span><span class="p">)</span>
        <span class="n">lay_</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="p">)</span>
        <span class="n">lay</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">lay</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">lay_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tag_filter_widget</span> <span class="o">=</span> <span class="n">TagFilterWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dw_image_list</span><span class="p">)</span>
        <span class="n">lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tag_filter_widget</span><span class="p">)</span>
        <span class="n">lay</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">)</span>
        <span class="n">widg</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="n">widg</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">lay</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dw_image_list</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="n">widg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_image_list</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Photos&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_image_list</span><span class="o">.</span><span class="n">setFloating</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_image_list</span><span class="o">.</span><span class="n">setFeatures</span><span class="p">(</span><span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetFloatable</span> <span class="o">|</span> <span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetMovable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_image_list</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addDockWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">LeftDockWidgetArea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dw_image_list</span><span class="p">)</span>

        <span class="c1"># Move this block to change the placement of this dockwidget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_segmentation</span> <span class="o">=</span> <span class="n">QDockWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_segmentation</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Segmentation and other&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_segmentation</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">region_computation_widget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_segmentation</span><span class="o">.</span><span class="n">setFeatures</span><span class="p">(</span><span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetFloatable</span> <span class="o">|</span> <span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetMovable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addDockWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">RightDockWidgetArea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dw_segmentation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_segmentation</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_segmentation</span><span class="o">.</span><span class="n">sizePolicy</span><span class="p">()</span><span class="o">.</span><span class="n">setVerticalStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># end of block</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dw_toolbox</span> <span class="o">=</span> <span class="n">QDockWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_toolbox</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Tools&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_toolbox</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">tool_box</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_toolbox</span><span class="o">.</span><span class="n">setFeatures</span><span class="p">(</span><span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetFloatable</span> <span class="o">|</span> <span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetMovable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addDockWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">RightDockWidgetArea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dw_toolbox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_toolbox</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_toolbox</span><span class="o">.</span><span class="n">sizePolicy</span><span class="p">()</span><span class="o">.</span><span class="n">setVerticalStretch</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dw_labels</span> <span class="o">=</span> <span class="n">QDockWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_labels</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Labels&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_labels</span><span class="o">.</span><span class="n">setWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">_label_tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_labels</span><span class="o">.</span><span class="n">setFeatures</span><span class="p">(</span><span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetFloatable</span> <span class="o">|</span> <span class="n">QDockWidget</span><span class="o">.</span><span class="n">DockWidgetMovable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addDockWidget</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">RightDockWidgetArea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dw_labels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_labels</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_labels</span><span class="o">.</span><span class="n">sizePolicy</span><span class="p">()</span><span class="o">.</span><span class="n">setVerticalStretch</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dw_image_list</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_labels</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_toolbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_segmentation</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_label_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">label_layer</span><span class="o">.</span><span class="n">label_hovered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_label_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">lblLabelIcon</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;border: 1px solid black&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins_widget</span><span class="o">.</span><span class="n">all_region_computations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">region_computation_widget</span><span class="o">.</span><span class="n">register_computation</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins_widget</span><span class="o">.</span><span class="n">all_measurement_computations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurements_viewer</span><span class="o">.</span><span class="n">computation_widget</span><span class="o">.</span><span class="n">register_computation</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">region_computation_widget</span><span class="o">.</span><span class="n">apply_computation</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_regions3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">register_tools</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>

        <span class="n">hbox</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="n">hbox</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">widget</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">tabLabelEditor</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">hbox</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="s1">&#39;undo.png&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">undo_icon</span> <span class="o">=</span> <span class="n">QIcon</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">redo_pix</span> <span class="o">=</span> <span class="n">QImage</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">redo_pix</span> <span class="o">=</span> <span class="n">QPixmap</span><span class="o">.</span><span class="n">fromImage</span><span class="p">(</span><span class="n">redo_pix</span><span class="o">.</span><span class="n">mirrored</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">redo_icon</span> <span class="o">=</span> <span class="n">QIcon</span><span class="p">(</span><span class="n">redo_pix</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionRedo</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">redo_icon</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionUndo</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">undo_icon</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">tbtnRedo</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">redo_icon</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">tbtnUndo</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">undo_icon</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">first_photo_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_first_photo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">prev_photo_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_prev_photo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">next_photo_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_next_photo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">last_photo_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_last_photo</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">unsaved_changes</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_actionSave</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_image_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">imageListView</span><span class="o">.</span><span class="n">setParent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">imageListView</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span> <span class="o">=</span> <span class="n">ImageListView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">centralwidget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">show_tag_ui</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_tag_ui</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">hide_tag_ui</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">close_photo_tags_widget</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setModel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">currentChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_current_changed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">selectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_selection_changed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">sliderPressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">handle_slider_pressed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">sliderReleased</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_image_list_slider_released</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setVerticalScrollMode</span><span class="p">(</span><span class="n">QListView</span><span class="o">.</span><span class="n">ScrollPerPixel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">entered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_thumbnail_gui</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setMouseTracking</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span><span class="p">:</span> <span class="n">QModelIndex</span> <span class="o">=</span> <span class="n">QModelIndex</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_delegate</span> <span class="o">=</span> <span class="n">ImageListDelegate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span><span class="p">)</span> <span class="c1">#ThumbnailDelegate(self.thumbnail_storage)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setItemDelegate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_delegate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_delegate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">view_left</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hide_thumb_gui</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setUniformItemSizes</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">))</span>
        <span class="c1"># TODO: For whatever reason, even with &quot;self.image_list.setVerticalScrollBarPolicy(Qt.ScrollBarAlwaysOn)&quot;, self.image_list.verticalScrollBar().rect().width() == 100 at this point, which seems to be nonsense (width of a scrollbar, reasonable value is e.g. 17).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setVerticalScrollBarPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarAlwaysOn</span><span class="p">)</span>
        <span class="c1"># self.image_list.setMinimumWidth(self.thumbnail_storage.thumbnail_size.width() + self.image_list.verticalScrollBar().rect().width() + 2 * self.image_list.frameWidth())</span>
        <span class="c1"># self.image_list.setMaximumWidth(self.thumbnail_storage.thumbnail_size.width() + self.image_list.verticalScrollBar().rect().width() + 2 * self.image_list.frameWidth())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">approval_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">handle_approval_changed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="s1">&#39;(no filtering)&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_tag_filter_changed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">lblTagFilter</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tags_filter_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_tags_filter_changed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_version_checking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setups the stuff for version checking against the remote gitlab repository.&quot;&quot;&quot;</span>

        <span class="c1"># ---- stuff related to checking whether there is a new commit pertaining to the current git branch -----</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__gl_project_token</span> <span class="o">=</span> <span class="s2">&quot;otxwJ_8ywJfDsuENMcDE&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__current_branch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__local_commit_message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__remote_version_datetime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__remote_commit_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Don&#39;t let this crash the whole application</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__current_branch</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;rev-parse&#39;</span><span class="p">,</span> <span class="s1">&#39;--abbrev-ref&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                   <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=&quot;</span><span class="si">%c</span><span class="s1">I&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">],</span>
                                                     <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__local_commit_message</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=&quot;%B&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">],</span>
                                                         <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__remote_version_datetime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__remote_commit_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__local_commit_message</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not obtain git info about local and remote branch&quot;</span><span class="p">)</span>
        <span class="c1"># Disable the &quot;?&quot; button (next to the closing &quot;X&quot;) in all dialogs.</span>
        <span class="n">stat_lay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBar</span><span class="p">()</span>
        <span class="n">stat_lay</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Dev info: &quot;</span><span class="p">))</span>
        <span class="n">stat_lay</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Current branch: &quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_current_branch</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__current_branch</span><span class="p">)</span>
        <span class="n">stat_lay</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lbl_current_branch</span><span class="p">)</span>
        <span class="n">stat_lay</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Version datetime:&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_current_datetime</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span><span class="p">))</span>
        <span class="n">stat_lay</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lbl_current_datetime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_current_datetime</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: green&quot;</span><span class="p">)</span>
        <span class="n">stat_lay</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Remote version datetime:&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_remote_datetime</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__remote_version_datetime</span><span class="p">))</span>
        <span class="n">stat_lay</span><span class="o">.</span><span class="n">addPermanentWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lbl_remote_datetime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_remote_datetime</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: green&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setStatusBar</span><span class="p">(</span><span class="n">stat_lay</span><span class="p">)</span>
        <span class="n">stat_lay</span><span class="o">.</span><span class="n">hideOrShow</span><span class="p">()</span>
        <span class="c1">#  ---------------------------------------------------------------------------</span>
        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__check_for_remote_version_datetime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__version_check_timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__version_check_timer</span><span class="o">.</span><span class="n">setInterval</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># check every 5 minutes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__version_check_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionVersion</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_show_version_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionOpen_project_folder</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_project_folder_in_explorer</span><span class="p">)</span>

<div class="viewcode-block" id="ArthropodDescriber.close_photo_tags_widget"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.close_photo_tags_widget">[docs]</a>    <span class="k">def</span> <span class="nf">close_photo_tags_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_index</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_tag_widget_left"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_tag_widget_left">[docs]</a>    <span class="k">def</span> <span class="nf">handle_tag_widget_left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">mapFromGlobal</span><span class="p">(</span><span class="n">QCursor</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">indexAt</span><span class="p">(</span><span class="n">point</span><span class="p">)</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_photo_tags_widget</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_load_default_label_hierarchies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;arthropod_describer&#39;</span><span class="p">,</span> <span class="s1">&#39;regions_label_hierarchy.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_hierarchies</span><span class="p">[</span><span class="s1">&#39;Labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LabelHierarchy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s1">&#39;arthropod_describer&#39;</span><span class="p">,</span> <span class="s1">&#39;reflections_label_hierarchy.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_hierarchies</span><span class="p">[</span><span class="s1">&#39;Reflections&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LabelHierarchy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<div class="viewcode-block" id="ArthropodDescriber.execute_general_action_or_show_settings"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.execute_general_action_or_show_settings">[docs]</a>    <span class="k">def</span> <span class="nf">execute_general_action_or_show_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qaction</span><span class="p">:</span> <span class="n">QAction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Executes a `GeneralAction` or shows a setting dialog if the given action provides some user parameters.</span>

<span class="sd">        :param qaction: The action that was triggered by the user.</span>
<span class="sd">        :type qaction: QAction</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        :rtype: None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">GeneralAction</span> <span class="o">=</span> <span class="n">qaction</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">widget</span><span class="p">,</span> <span class="n">diag_butt_box</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_params_widget_with_buttons</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">user_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

            <span class="n">diag_box</span><span class="p">:</span> <span class="n">QDialogButtonBox</span> <span class="o">=</span> <span class="n">diag_butt_box</span>
            <span class="n">diag_box</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">Apply</span><span class="p">)</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_general_action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">widget</span><span class="p">))</span>
            <span class="n">diag_box</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="n">QDialogButtonBox</span><span class="o">.</span><span class="n">Cancel</span><span class="p">)</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispose_of_general_action_settings</span><span class="p">(</span><span class="n">widget</span><span class="p">))</span>

            <span class="n">binding</span> <span class="o">=</span> <span class="n">UserParamWidgetBinding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="n">binding</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">user_params</span><span class="p">,</span> <span class="n">widget</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ApplicationModal</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_general_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.execute_general_action"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.execute_general_action">[docs]</a>    <span class="k">def</span> <span class="nf">execute_general_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">GeneralAction</span><span class="p">,</span> <span class="n">widget</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">QWidget</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">widget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
        <span class="n">action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.dispose_of_general_action_settings"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.dispose_of_general_action_settings">[docs]</a>    <span class="k">def</span> <span class="nf">dispose_of_general_action_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">:</span> <span class="n">QWidget</span><span class="p">):</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_handle_scales_accepted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_count</span><span class="p">):</span>
            <span class="n">photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">scale_set_tuple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">scale_settings</span><span class="p">[</span><span class="n">photo</span><span class="o">.</span><span class="n">image_path</span><span class="p">]</span>
            <span class="n">photo</span><span class="o">.</span><span class="n">scale_setting</span> <span class="o">=</span> <span class="n">scale_set_tuple</span><span class="o">.</span><span class="n">new_scale_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">switch_to_label_editor</span><span class="p">()</span>

        <span class="c1"># Update any rulers (and their total length display) after a scale change.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">_current_tool</span><span class="p">,</span> <span class="n">Tool_Ruler</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">_current_tool</span><span class="o">.</span><span class="n">set_out_widget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">tool_out_widget</span><span class="p">)</span>
            <span class="c1"># TODO: Update the ruler visualization with something like</span>
            <span class="c1">#       self.label_editor.viz_layer.repaint() ?</span>

<div class="viewcode-block" id="ArthropodDescriber.save_project"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.save_project">[docs]</a>    <span class="k">def</span> <span class="nf">save_project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">first_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QModelIndex</span><span class="p">())</span>
        <span class="n">last_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QModelIndex</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">dataChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">first_index</span><span class="p">,</span>
                                               <span class="n">last_index</span><span class="p">,</span>
                                               <span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionSave</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_highlight_photo_in_image_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photo</span><span class="p">:</span> <span class="n">Photo</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">highlight_indexes</span><span class="p">([</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_handle_image_op_photo_rotated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photo</span><span class="p">:</span> <span class="n">Photo</span><span class="p">,</span> <span class="n">cw</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="c1"># Rotate the rulers</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">_current_tool</span><span class="p">,</span> <span class="n">Tool_Ruler</span><span class="p">):</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># Flip width and height, because this is happening after the photo has already rotated.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">_current_tool</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="ow">not</span> <span class="n">cw</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>

        <span class="c1"># TODO: Why is this `return` here, and unreachable code beyond it?</span>
        <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">reset_tool</span><span class="p">()</span>
        <span class="n">photo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">photo</span><span class="o">.</span><span class="n">image_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span> <span class="o">=</span> <span class="n">photo</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">set_photo</span><span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="n">reset_view</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span><span class="o">.</span><span class="n">rotate_thumbnail</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">cw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">highlight_indexes</span><span class="p">([])</span>

    <span class="k">def</span> <span class="nf">_handle_image_op_photo_resized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photo</span><span class="p">:</span> <span class="n">Photo</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">reset_tool</span><span class="p">()</span>
        <span class="n">photo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;resize images size is </span><span class="si">{</span><span class="n">photo</span><span class="o">.</span><span class="n">image_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">photo</span><span class="o">.</span><span class="n">image_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span> <span class="o">=</span> <span class="n">photo</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">set_photo</span><span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="n">reset_view</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">highlight_indexes</span><span class="p">([])</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span><span class="o">.</span><span class="n">generate_thumbnail</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span><span class="o">.</span><span class="n">reload_thumbnail</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_tab_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tab_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tab_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dw_labels</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dw_toolbox</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dw_segmentation</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dw_labels</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dw_toolbox</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dw_segmentation</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_show_version_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span><span class="p">)</span>
        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Arthropod Describer version&quot;</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s1">&#39;Current branch: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__current_branch</span><span class="si">}</span><span class="se">\n</span><span class="s1">Current version date: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span><span class="si">}</span><span class="se">\n</span><span class="s1">Remote version date: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__remote_version_datetime</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__fetch_remote_version_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://gitlab.fi.muni.cz/api/v4/projects/20999/repository/commits/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__current_branch</span><span class="si">}</span><span class="s1">?private_token=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__gl_project_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                      <span class="n">timeout</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span>
        <span class="n">resp_obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="n">__remote_version_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">resp_obj</span><span class="p">[</span><span class="s1">&#39;committed_date&#39;</span><span class="p">])</span>
        <span class="n">__remote_version_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">__remote_version_datetime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">__remote_version_datetime</span><span class="p">,</span> <span class="n">resp_obj</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__check_for_remote_version_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">remote_version</span><span class="p">,</span> <span class="n">commit_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fetch_remote_version_datetime</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">remote_version</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__remote_version_datetime</span><span class="p">:</span> <span class="c1"># Don&#39;t show the dialog repeatedly if the remote_version is already familiar to the app.</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__remote_version_datetime</span> <span class="o">=</span> <span class="n">remote_version</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__remote_commit_message</span> <span class="o">=</span> <span class="n">commit_message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_remote_datetime</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__remote_version_datetime</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__remote_version_datetime</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;There is a new commit in the remote </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__current_branch</span><span class="si">}</span><span class="s1"> branch</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;Datetime: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__remote_version_datetime</span><span class="si">}</span><span class="se">\n</span><span class="s1">Commit message: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__remote_commit_message</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;New version available&quot;</span><span class="p">,</span>
                                        <span class="n">msg</span><span class="p">,</span>
                                        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_current_datetime</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: red&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_remote_datetime</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: green&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__version_datetime</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__remote_version_datetime</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_remote_datetime</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: red&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_current_datetime</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: green&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_remote_datetime</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: green&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__lbl_current_datetime</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&quot;color: green&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not obtain remote repo info reason: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not obtain remote repo info&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ArthropodDescriber.handle_copying_finished"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_copying_finished">[docs]</a>    <span class="nd">@Slot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">handle_copying_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_dialog</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArthropodDescriber.update_applyToUnsegmented_state"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.update_applyToUnsegmented_state">[docs]</a>    <span class="k">def</span> <span class="nf">update_applyToUnsegmented_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">unsegmented_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_count</span><span class="p">):</span>
                <span class="n">photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_idx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">photo</span><span class="o">.</span><span class="n">has_segmentation_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">default_label_image</span><span class="p">):</span>
                    <span class="n">unsegmented_count</span> <span class="o">=</span> <span class="n">unsegmented_count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">apply_to_all_unsegmented_text</span> <span class="o">=</span> <span class="s2">&quot;Apply to all unsegmented&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">region_computation_widget</span><span class="o">.</span><span class="n">action_applyToUnsegmented</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">apply_to_all_unsegmented_text</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">unsegmented_count</span> <span class="k">if</span> <span class="n">unsegmented_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">region_computation_widget</span><span class="o">.</span><span class="n">action_applyToUnsegmented</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">unsegmented_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_load_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Attempting to load tools&#39;</span><span class="p">)</span>
        <span class="n">py_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmodulename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;tools&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;__init__.py&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">py_files</span><span class="p">)</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;.tools&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">py_files</span><span class="p">]</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
            <span class="n">members</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">obj_name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">obj_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Tool_&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isabstract</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                    <span class="n">tool</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                    <span class="n">tool</span><span class="o">.</span><span class="n">set_tool_id</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">colormap_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">color_map_changed</span><span class="p">)</span> <span class="c1">#lambda cmap: tool.color_map_changed(cmap.colormap))</span>
                    <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span><span class="si">}</span><span class="s1"> tools&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ArthropodDescriber.handle_tags_filter_changed"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_tags_filter_changed">[docs]</a>    <span class="k">def</span> <span class="nf">handle_tags_filter_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">active_tags</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">invalidate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_first_photo</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_tag_filter_changed"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_tag_filter_changed">[docs]</a>    <span class="k">def</span> <span class="nf">handle_tag_filter_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_selection</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">currentData</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">setFilterFixedString</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_first_photo</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">setFilterFixedString</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_first_photo</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_new_tag_added"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_new_tag_added">[docs]</a>    <span class="k">def</span> <span class="nf">handle_new_tag_added</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photo</span><span class="p">:</span> <span class="n">Photo</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">tags</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">used_tags</span><span class="p">))</span>
        <span class="n">tag_index</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># offset by 1 because the option &quot;(no filter)&quot; is not present in `tags` and is always at index 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">insertItem</span><span class="p">(</span><span class="n">tag_index</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.repopulate_tags_combobox"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.repopulate_tags_combobox">[docs]</a>    <span class="k">def</span> <span class="nf">repopulate_tags_combobox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">count</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">removeItem</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">tags</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">used_tags</span>

        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">userData</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">cmbTags</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.hide_thumb_gui"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.hide_thumb_gui">[docs]</a>    <span class="k">def</span> <span class="nf">hide_thumb_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setIndexWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_index</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span> <span class="o">=</span> <span class="n">QModelIndex</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cursor_pos</span> <span class="o">=</span> <span class="n">QCursor</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span>
            <span class="n">tag_rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span><span class="o">.</span><span class="n">translated</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">tag_rect</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">cursor_pos</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_photo_tags_widget</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.show_thumbnail_gui"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.show_thumbnail_gui">[docs]</a>    <span class="k">def</span> <span class="nf">show_thumbnail_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span><span class="o">.</span><span class="n">isValid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setIndexWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_index</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span> <span class="o">=</span> <span class="n">QModelIndex</span><span class="p">()</span>
        <span class="n">actual_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_idx</span><span class="p">(</span><span class="n">actual_index</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="n">load_image</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">photo</span><span class="o">.</span><span class="n">image_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">:</span>
            <span class="n">photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_idx</span><span class="p">(</span><span class="n">actual_index</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="n">load_image</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_op</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">photo</span><span class="p">)</span>
        <span class="n">widg</span> <span class="o">=</span> <span class="n">ThumbGUI</span><span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">)</span>
        <span class="c1">#widg.rotate_requested.connect(self.handle_rotation_requested)</span>
        <span class="n">widg</span><span class="o">.</span><span class="n">rotate_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">cw</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_op</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">cw</span><span class="p">))</span>
        <span class="n">widg</span><span class="o">.</span><span class="n">resize_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_op</span><span class="o">.</span><span class="n">resize</span><span class="p">())</span>
        <span class="n">widg</span><span class="o">.</span><span class="n">resolution_setting_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_resolution_setting_requested</span><span class="p">)</span>
        <span class="n">widg</span><span class="o">.</span><span class="n">save_photo</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_photo</span><span class="p">)</span>
        <span class="n">widg</span><span class="o">.</span><span class="n">delete_photo_requested</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_delete_photo_requested</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setIndexWidget</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">widg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="n">widg</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.show_tag_ui"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.show_tag_ui">[docs]</a>    <span class="k">def</span> <span class="nf">show_tag_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="n">actual_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_idx</span><span class="p">(</span><span class="n">actual_index</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="n">load_image</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_photo_tags_widget</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span> <span class="o">=</span> <span class="n">PhotoTagsWidget</span><span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Window</span>
                                                      <span class="c1"># | Qt.WindowStaysOnTopHint</span>
                                                      <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">X11BypassWindowManagerHint</span>
                                                      <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">FramelessWindowHint</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="o">.</span><span class="n">populate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">NonModal</span><span class="p">)</span>

            <span class="c1"># rect = self.image_list.visualRect(index)</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">delegate</span><span class="o">.</span><span class="n">tag_rects</span><span class="p">[</span><span class="n">index</span><span class="o">.</span><span class="n">row</span><span class="p">()]</span>
            <span class="n">top_right</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">topRight</span><span class="p">()</span>
            <span class="c1"># app_top_right = self.image_list.mapTo(self, top_right) + self.pos()</span>
            <span class="n">app_top_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">mapToGlobal</span><span class="p">(</span><span class="n">top_right</span><span class="p">)</span>
            <span class="c1"># Adjust the Y-position of the panel so that it fits on the screen vertically (unless it is itself too tall -- in that case, scrolling or multi-column layout may be necessary).</span>
            <span class="n">app_top_right</span><span class="o">.</span><span class="n">setY</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">app_top_right</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">()</span><span class="o">.</span><span class="n">availableGeometry</span><span class="p">()</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="o">.</span><span class="n">height</span><span class="p">()),</span> <span class="mi">0</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">app_top_right</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_index</span> <span class="o">=</span> <span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_tag_widget</span><span class="o">.</span><span class="n">widget_left</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_tag_widget_left</span><span class="p">)</span></div>
            <span class="c1"># self.current_tag_widget.add_new_tag.connect(self.handle_new_tag_added)</span>

    <span class="k">def</span> <span class="nf">_save_photo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photo</span><span class="p">:</span> <span class="n">Photo</span><span class="p">):</span>
        <span class="n">photo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QModelIndex</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">dataChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>

<div class="viewcode-block" id="ArthropodDescriber.handle_thumbnail_gui_rotate_request"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_thumbnail_gui_rotate_request">[docs]</a>    <span class="k">def</span> <span class="nf">handle_thumbnail_gui_rotate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">:</span> <span class="n">ThumbGUI</span><span class="p">,</span> <span class="n">im_op</span><span class="p">:</span> <span class="n">ImageOperation</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">photo</span><span class="p">:</span> <span class="n">Photo</span><span class="p">,</span> <span class="n">cw</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">im_op</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">cw</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rotate</span></div>

<div class="viewcode-block" id="ArthropodDescriber.set_storage"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.set_storage">[docs]</a>    <span class="k">def</span> <span class="nf">set_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">Storage</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting storage to </span><span class="si">{</span><span class="n">storage</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lbl_name</span> <span class="ow">in</span> <span class="n">storage</span><span class="o">.</span><span class="n">label_image_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">storage</span><span class="o">.</span><span class="n">get_label_hierarchy2</span><span class="p">(</span><span class="n">lbl_name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">storage</span><span class="o">.</span><span class="n">set_label_hierarchy2</span><span class="p">(</span><span class="n">lbl_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_hierarchies</span><span class="p">[</span><span class="n">lbl_name</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins_menu</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">storage_update</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_storage_updated</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tag_filter_widget</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_label_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">default_label_image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_label_constraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_label_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_executor</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span> <span class="o">=</span> <span class="n">ThumbnailStorage_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_delegate</span> <span class="o">=</span> <span class="n">ImageListDelegate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_delegate</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurements_viewer</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">MaskGroup</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">_label_switch</span><span class="o">.</span><span class="n">set_label_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_label_hierarchy2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_label_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">set_photo</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_idx</span><span class="p">,</span> <span class="n">QItemSelectionModel</span><span class="o">.</span><span class="n">Select</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Arthropod Describer - </span><span class="si">{</span><span class="n">storage</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionImportPhotos</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measurements_viewer</span><span class="o">.</span><span class="n">update_measurements_view</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionOpen_project_folder</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">constraint_label</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dw_image_list</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_labels</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_toolbox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dw_segmentation</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Preferred</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setVerticalScrollBarPolicy</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ScrollBarAlwaysOn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setMinimumWidth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span><span class="o">.</span><span class="n">thumbnail_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">frameWidth</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setMaximumWidth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span><span class="o">.</span><span class="n">thumbnail_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">frameWidth</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setSizePolicy</span><span class="p">(</span><span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">repopulate_tags_combobox</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_storage_updated"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_storage_updated">[docs]</a>    <span class="k">def</span> <span class="nf">handle_storage_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]):</span>
        <span class="k">if</span> <span class="s1">&#39;tags&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repopulate_tags_combobox</span><span class="p">()</span></div>
            <span class="c1"># if &#39;new&#39; in data[&#39;tags&#39;]:</span>
            <span class="c1">#     self.add_tags_to_dropdown(data[&#39;tags&#39;][&#39;new&#39;])</span>
            <span class="c1"># if &#39;deleted&#39; in data[&#39;tags&#39;]:</span>
            <span class="c1">#     self.remove_tags_from_dropdown(data[&#39;tags&#39;][&#39;deleted&#39;])</span>

    <span class="c1"># def add_tags_to_dropdown(self, tags: typing.Set[str]):</span>
    <span class="c1">#     new_tags_sorted = list(sorted(tags))</span>
    <span class="c1">#     all_tags = list(sorted(self.storage.used_tags))</span>
    <span class="c1">#</span>
    <span class="c1">#     for tag in new_tags_sorted:</span>
    <span class="c1">#         idx = all_tags.index(tag)</span>
    <span class="c1">#         self.ui.cmbTags</span>

<div class="viewcode-block" id="ArthropodDescriber.fetch_photo"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.fetch_photo">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_photo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">rowCount</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="c1"># TODO add guard to ensure idx &gt;= 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span><span class="n">QListView</span><span class="o">.</span><span class="n">SingleSelection</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prev_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>
            <span class="n">curr_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
            <span class="n">curr_idx_mapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span><span class="n">curr_idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">curr_idx_mapped</span><span class="o">.</span><span class="n">row</span><span class="p">()</span> <span class="o">!=</span> <span class="n">prev_idx</span><span class="p">:</span>
                <span class="n">_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">prev_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapFromSource</span><span class="p">(</span><span class="n">_idx</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prev_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fetching photo with the index = </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1"> (previous photo index is </span><span class="si">{</span><span class="n">prev_idx</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">new_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapFromSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="c1"># self.label_editor.image_viewer.enable_navigation_buttons(new_index.row(), self.image_list_proxy_model.rowCount())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_image_viewer</span><span class="o">.</span><span class="n">enable_navigation_buttons</span><span class="p">(</span><span class="n">new_index</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">new_index</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.fetch_first_photo"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.fetch_first_photo">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_first_photo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_photo</span><span class="p">(</span><span class="n">new_index</span><span class="o">.</span><span class="n">row</span><span class="p">())</span></div>

<div class="viewcode-block" id="ArthropodDescriber.fetch_prev_photo"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.fetch_prev_photo">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_prev_photo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span>
            <span class="c1"># self.image_list_proxy_model.index(max(0, self.image_list.currentIndex().row() - 1), 0)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_idx</span><span class="o">.</span><span class="n">row</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_photo</span><span class="p">(</span><span class="n">new_index</span><span class="o">.</span><span class="n">row</span><span class="p">())</span></div>

<div class="viewcode-block" id="ArthropodDescriber.fetch_next_photo"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.fetch_next_photo">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_next_photo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                <span class="c1"># min(self.image_list.currentIndex().row() + 1, self.image_list_proxy_model.rowCount() - 1),</span>
                <span class="c1"># 0)</span>
                <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_idx</span><span class="o">.</span><span class="n">row</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_photo</span><span class="p">(</span><span class="n">new_index</span><span class="o">.</span><span class="n">row</span><span class="p">())</span></div>

<div class="viewcode-block" id="ArthropodDescriber.fetch_last_photo"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.fetch_last_photo">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_last_photo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_photo</span><span class="p">(</span><span class="n">new_index</span><span class="o">.</span><span class="n">row</span><span class="p">())</span></div>

<div class="viewcode-block" id="ArthropodDescriber.clear_selection"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.clear_selection">[docs]</a>    <span class="k">def</span> <span class="nf">clear_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">clearSelection</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArthropodDescriber.clear_multi_selection"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.clear_multi_selection">[docs]</a>    <span class="k">def</span> <span class="nf">clear_multi_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deselects everything except the photo that was selected first.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">selection</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_idx</span><span class="p">)</span>

        <span class="n">first</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">idx</span><span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">row</span><span class="p">())</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">idx</span><span class="p">:</span> <span class="n">idx</span><span class="o">.</span><span class="n">row</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">QItemSelection</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="n">QItemSelectionModel</span><span class="o">.</span><span class="n">Deselect</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_action_import_folder_triggered"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_action_import_folder_triggered">[docs]</a>    <span class="k">def</span> <span class="nf">handle_action_import_folder_triggered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checked</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_dialog</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_current_changed"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_current_changed">[docs]</a>    <span class="k">def</span> <span class="nf">handle_current_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">,</span> <span class="n">previous</span><span class="p">:</span> <span class="n">QModelIndex</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>
        <span class="c1"># if self.image_list.selectionMode() != ImageListView.SingleSelection:</span>
        <span class="c1">#     logging.info(f&#39;handle_current_changed, selection mode is not SingleSelection (is {self.image_list.selectionMode()}, returning&#39;)</span>
        <span class="c1">#     return</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image list current item changed from index </span><span class="si">{</span><span class="n">previous</span><span class="o">.</span><span class="n">row</span><span class="p">()</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">previous</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span><span class="si">}</span><span class="s1">) to </span><span class="si">{</span><span class="n">current</span><span class="o">.</span><span class="n">row</span><span class="p">()</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">current</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="n">mapped_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">mapped_index</span><span class="o">.</span><span class="n">row</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unloading the current photo </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lbl_img</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">label_images_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">lbl_img</span><span class="o">.</span><span class="n">unload</span><span class="p">()</span>
        <span class="n">photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_idx</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span> <span class="o">=</span> <span class="n">photo</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current photo is now </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current photo is now </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_image_viewer</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">set_photo</span><span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">enable_navigation_buttons</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">set_photo</span><span class="p">(</span><span class="n">photo</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">enable_navigation_buttons</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">row</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_idx</span> <span class="o">=</span> <span class="n">current</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_selection_changed"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_selection_changed">[docs]</a>    <span class="k">def</span> <span class="nf">handle_selection_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected</span><span class="p">:</span> <span class="n">QItemSelection</span><span class="p">,</span> <span class="n">deselected</span><span class="p">:</span> <span class="n">QItemSelection</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">QItemSelection</span><span class="p">(</span><span class="n">deselected</span><span class="o">.</span><span class="n">indexes</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                                                    <span class="n">deselected</span><span class="o">.</span><span class="n">indexes</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">QItemSelectionModel</span><span class="o">.</span><span class="n">Select</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_image_list_slider_released"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_image_list_slider_released">[docs]</a>    <span class="k">def</span> <span class="nf">handle_image_list_slider_released</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">first_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">indexAt</span><span class="p">(</span><span class="n">QPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">last_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">indexAt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">viewport</span><span class="p">()</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span><span class="o">.</span><span class="n">bottomLeft</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">handle_slider_released</span><span class="p">(</span><span class="n">first_idx</span><span class="p">,</span> <span class="n">last_idx</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_action_import_photos_triggered"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_action_import_photos_triggered">[docs]</a>    <span class="k">def</span> <span class="nf">handle_action_import_photos_triggered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_dialog</span><span class="o">.</span><span class="n">open_for_importing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">storage_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.exit_application"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.exit_application">[docs]</a>    <span class="k">def</span> <span class="nf">exit_application</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArthropodDescriber.closeEvent"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.closeEvent">[docs]</a>    <span class="k">def</span> <span class="nf">closeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">QCloseEvent</span><span class="p">):</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Confirmation&#39;</span><span class="p">,</span> <span class="s1">&#39;Do you really want to exit?&#39;</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reply</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
            <span class="c1"># self.thumbnail_storage.stop()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">release_resources</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">()</span>
            <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">ignore</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_action_open_project_triggered"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_action_open_project_triggered">[docs]</a>    <span class="k">def</span> <span class="nf">handle_action_open_project_triggered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">maybe_path</span> <span class="o">=</span> <span class="n">choose_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Open project folder&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maybe_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_project</span><span class="p">(</span><span class="n">maybe_path</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_move_recent_project_action_to_front</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">QAction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Puts the entry of the most recently opened project at the first place in the recently opened projects menu.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">removeAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">actions</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">insertAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">actions</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span> <span class="n">action</span><span class="p">)</span>  <span class="c1"># Add just after the separator (at index 2).</span>

<div class="viewcode-block" id="ArthropodDescriber.open_project"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.open_project">[docs]</a>    <span class="k">def</span> <span class="nf">open_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">temp_storage</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TempStorage</span><span class="p">]):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempting to open the project from </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Stopping ThumbnailStorage&#39;</span><span class="p">)</span>
                <span class="c1"># self.thumbnail_storage.stop()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attemtpting to load LocalStorage from </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">strg</span> <span class="o">=</span> <span class="n">LocalStorage</span><span class="o">.</span><span class="n">load_from</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>  <span class="c1"># &lt;-- This is where the exception happens if the .json is not found.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_storage</span><span class="p">(</span><span class="n">strg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">temp_storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting scale infos for the TempStorage&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">photo_to_import</span> <span class="ow">in</span> <span class="n">temp_storage</span><span class="o">.</span><span class="n">photos_to_import</span><span class="p">:</span>
                    <span class="n">photo</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">get_photo_by_name</span><span class="p">(</span><span class="n">photo_to_import</span><span class="o">.</span><span class="n">image_name</span><span class="p">,</span> <span class="n">load_image</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">photo</span><span class="o">.</span><span class="n">scale_setting</span> <span class="o">=</span> <span class="n">photo_to_import</span><span class="o">.</span><span class="n">import_info</span><span class="o">.</span><span class="n">scale_info</span>
                    <span class="n">photo</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">photo_to_import</span><span class="o">.</span><span class="n">tags</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">set_photo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Repopulating combobox&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repopulate_tags_combobox</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving storage&#39;</span><span class="p">)</span>
            <span class="n">strg</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saved storage&#39;</span><span class="p">)</span>

            <span class="n">folder_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">project_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;project_paths&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">folder_string</span> <span class="ow">in</span> <span class="n">project_paths</span><span class="p">:</span>
                <span class="c1">#return # TODO: This `return` was here, but seemed incorrect. Instead, moving the project to the beginning of the list was added.</span>
                <span class="n">project_paths</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">folder_string</span><span class="p">)</span>
                <span class="n">project_paths</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">folder_string</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">project_paths</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">folder_string</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving config&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saved config&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating recently opened&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_populate_recently_opened_menu</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populated recently opened&#39;</span><span class="p">)</span>
            <span class="c1"># Move the added/updated menu action to the front.</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QAction</span><span class="p">,</span> <span class="n">folder_string</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_move_recent_project_action_to_front</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

            <span class="c1"># TODO: Was this okay? `self.import_dialog.hide()` is here, but originally, we might have already</span>
            <span class="c1">#       left the function because of `if str(folder) in project_paths: return` -- that return has</span>
            <span class="c1">#       now been removed.</span>
            <span class="c1">#       .</span>
            <span class="c1">#       This becomes relevant only when creating a new project -- the project is created, then opened (during which it is added to the front of the recent list), and then the import/create window is closed.</span>
            <span class="c1">#       What happens when creating a project with a name/location that already exists?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">import_dialog</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_applyToUnsegmented_state</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">error_message</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">error_message</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s1">&#39;Project not opened&#39;</span><span class="p">)</span>
            <span class="n">error_message</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unable to open project from &quot;</span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>
            <span class="n">error_message</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
            <span class="n">error_message</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">folder_str</span> <span class="o">:=</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project_paths&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project_paths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">folder_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QAction</span><span class="p">,</span> <span class="n">folder_str</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">removeAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.include_photos"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.include_photos">[docs]</a>    <span class="k">def</span> <span class="nf">include_photos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_storage</span><span class="p">:</span> <span class="n">TempStorage</span><span class="p">):</span>
        <span class="c1"># TODO switch to scale setting with for these photos only.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scale</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_dialog</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">spinBoxImageScale</span><span class="o">.</span><span class="n">value</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">include_photos</span><span class="p">([</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span> <span class="k">for</span> <span class="n">photo</span> <span class="ow">in</span> <span class="n">temp_storage</span><span class="o">.</span><span class="n">photos_to_import</span>
                                           <span class="k">if</span> <span class="n">photo</span><span class="o">.</span><span class="n">import_info</span><span class="o">.</span><span class="n">include</span><span class="p">],</span> <span class="n">scale</span><span class="p">)</span>
        <span class="c1"># self.thumbnail_storage.initialize(self.state.storage)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thumbnail_storage</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_dialog</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_executor</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_first_photo</span><span class="p">()</span>
        <span class="c1"># self.state.storage.blockSignals(True)</span>
        <span class="k">for</span> <span class="n">temp_photo</span> <span class="ow">in</span> <span class="n">temp_storage</span><span class="o">.</span><span class="n">photos_to_import</span><span class="p">:</span>
            <span class="n">photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_name</span><span class="p">(</span><span class="n">temp_photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">,</span> <span class="n">load_image</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">photo</span><span class="o">.</span><span class="n">scale_setting</span> <span class="o">=</span> <span class="n">temp_photo</span><span class="o">.</span><span class="n">import_info</span><span class="o">.</span><span class="n">scale_info</span>
            <span class="n">photo</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">temp_photo</span><span class="o">.</span><span class="n">tags</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>
            <span class="c1"># self.thumbnail_storage.generate_thumbnail(idx)</span>
            <span class="c1"># self.thumbnail_storage.reload_thumbnail(idx)</span>
        <span class="c1"># self.state.storage.blockSignals(False)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_applyToUnsegmented_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repopulate_tags_combobox</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArthropodDescriber.load_config"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.load_config">[docs]</a>    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;config.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;project_paths&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;label_image_assignments&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">[</span><span class="s1">&#39;Labels&#39;</span><span class="p">,</span> <span class="s2">&quot;Regions&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                    <span class="p">[</span><span class="s2">&quot;Reflections&quot;</span><span class="p">,</span> <span class="s2">&quot;Mask&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;config.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;label_image_assignments&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;label_image_assignments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="s1">&#39;Labels&#39;</span><span class="p">,</span> <span class="s2">&quot;Regions&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                    <span class="p">[</span><span class="s2">&quot;Reflections&quot;</span><span class="p">,</span> <span class="s2">&quot;Mask&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
                <span class="p">]</span></div>

<div class="viewcode-block" id="ArthropodDescriber.save_config"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.save_config">[docs]</a>    <span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;config.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_populate_recently_opened_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Add the &quot;Clear recent projects list&quot; action if not present.</span>
        <span class="n">clear_recent_project_list_text</span> <span class="o">=</span> <span class="s2">&quot;Clear recent projects list&quot;</span>
        <span class="n">clear_recent_project_list_name</span> <span class="o">=</span> <span class="s2">&quot;clear_recent_projects_list&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QAction</span><span class="p">,</span> <span class="n">clear_recent_project_list_name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="n">clear_recent_project_list_text</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="p">)</span>
            <span class="n">action</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="n">clear_recent_project_list_name</span><span class="p">)</span>
            <span class="n">action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clear_recently_opened_menu</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">addSeparator</span><span class="p">()</span>

        <span class="n">path_strings</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project_paths&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_strings</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project_paths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">findChild</span><span class="p">(</span><span class="n">QAction</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">QAction</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="p">)</span>
            <span class="n">action</span><span class="o">.</span><span class="n">setObjectName</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">action</span><span class="o">.</span><span class="n">triggered</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recent_project_action_handler</span><span class="p">(</span><span class="n">action</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionRecentlyOpened</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project_paths&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recent_project_action_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">QAction</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">handle_action_triggered</span><span class="p">():</span>
            <span class="n">path_text</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>

            <span class="c1"># Put the project that is just being opened at the front of the recent list.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_move_recent_project_action_to_front</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project_paths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path_text</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project_paths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">path_text</span><span class="p">)</span>

            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_text</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_project</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handle_action_triggered</span>

    <span class="k">def</span> <span class="nf">_clear_recently_opened_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;project_paths&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recently_opened_menu</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_recently_opened_menu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">()</span>

<div class="viewcode-block" id="ArthropodDescriber.toggle_label_info_visible"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.toggle_label_info_visible">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_label_info_visible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visible</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">layoutLabelInfo</span><span class="o">.</span><span class="n">count</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">layoutLabelInfo</span><span class="o">.</span><span class="n">itemAt</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="n">visible</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.show_label_info"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.show_label_info">[docs]</a>    <span class="k">def</span> <span class="nf">show_label_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_label_info_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_label</span> <span class="o">=</span> <span class="n">label</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_label</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_label</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">label</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toggle_label_info_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="c1">#info = f&#39;{self.state.colormap.label_names[label]} - code {self.state.label_hierarchy.code(label)}&#39;</span>
        <span class="n">lab_hier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">label_hierarchy</span>
        <span class="n">info</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lab_hier</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> - code </span><span class="si">{</span><span class="n">lab_hier</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">colormap</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_color_pixmap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">QColor</span><span class="o">.</span><span class="n">fromRgb</span><span class="p">(</span><span class="o">*</span><span class="n">color</span><span class="p">,</span> <span class="mi">255</span> <span class="k">if</span> <span class="n">label</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">lblLabelIcon</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_color_pixmap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">lblLabelInfo</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">info</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.open_project_folder_in_explorer"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.open_project_folder_in_explorer">[docs]</a>    <span class="k">def</span> <span class="nf">open_project_folder_in_explorer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Shouldn&#39;t even be necessary, as the QAction shouldn&#39;t be enabled in that case</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">location</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;xdg-open&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">location</span><span class="p">)])</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_rotation_requested"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_rotation_requested">[docs]</a>    <span class="k">def</span> <span class="nf">handle_rotation_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photo</span><span class="p">:</span> <span class="n">Photo</span><span class="p">,</span> <span class="n">clockwise</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rotating </span><span class="si">{</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">&quot;cw&quot;</span> <span class="k">if</span> <span class="n">clockwise</span> <span class="k">else</span> <span class="s2">&quot;ccw&quot;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_resize_requested"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_resize_requested">[docs]</a>    <span class="k">def</span> <span class="nf">handle_resize_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photo</span><span class="p">:</span> <span class="n">Photo</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;resizing </span><span class="si">{</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_resolution_setting_requested"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_resolution_setting_requested">[docs]</a>    <span class="k">def</span> <span class="nf">handle_resolution_setting_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photo</span><span class="p">:</span> <span class="n">Photo</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setting scale for </span><span class="si">{</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">SingleSelection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">switch_to_scale_setting</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">photo</span><span class="o">.</span><span class="n">image_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapFromSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">set_photo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.handle_delete_photo_requested"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.handle_delete_photo_requested">[docs]</a>    <span class="k">def</span> <span class="nf">handle_delete_photo_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photo</span><span class="p">:</span> <span class="n">Photo</span><span class="p">):</span>
        <span class="c1"># Ask for confirmation (warn explicitly if the action cannot be undone), and if confirmed, delete the photo from the project.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_photo_tags_widget</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Delete photo?&#39;</span><span class="p">,</span>
                                    <span class="sa">f</span><span class="s1">&#39;Do you really want to delete &quot;</span><span class="si">{</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="si">}</span><span class="s1">&quot; and all associated</span><span class="se">\n</span><span class="s1">segmentations and measurements from this project?</span><span class="se">\n\n</span><span class="s1">This action cannot be undone!&#39;</span><span class="p">,</span>
                                    <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">No</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reply</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;deleting </span><span class="si">{</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="si">}</span><span class="s1"> from the project&#39;</span><span class="p">)</span>
            <span class="c1"># TODO: Delete the photo and all associated data (segmentations, reflections, measurements, scale,</span>
            <span class="c1">#  rulers...) from the project.</span>
            <span class="c1">#  Careful:</span>
            <span class="c1">#  -- if it is the currently displayed photo (switch to another one, or display an empty window if it</span>
            <span class="c1">#     was the last one, clear undo/redo lists, remove rulers, cancel all drawing operations in progress,</span>
            <span class="c1">#     e.g. drawing a polygon...)</span>
            <span class="c1">#  -- if any computations using the photo to be deleted are still running (e.g. getting a thumbnail,</span>
            <span class="c1">#     or even some plugin)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurements_viewer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">beginResetModel</span><span class="p">()</span>
            <span class="n">current_photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span>
            <span class="n">current_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>

            <span class="n">next_photo_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Deleting the last photo in a particular (un)filtered view</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;after deletion there are no more photos (either due to filtering or all photos have been deleted), setting image viewer to None&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">set_photo</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If deleting the currently selected photo, compute the next photo that should be displayed and show it</span>
                <span class="k">if</span> <span class="n">photo</span><span class="o">.</span><span class="n">image_name</span> <span class="o">==</span> <span class="n">current_photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">current_index</span><span class="o">.</span><span class="n">row</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">new_photo_index</span> <span class="o">=</span> <span class="n">current_index</span><span class="o">.</span><span class="n">row</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_photo_index</span> <span class="o">=</span> <span class="n">current_index</span><span class="o">.</span><span class="n">row</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">index_to_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">new_photo_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">index_to_set_unmapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span><span class="n">index_to_set</span><span class="p">)</span>
                    <span class="n">next_photo_name</span> <span class="o">=</span> <span class="n">index_to_set_unmapped</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">ROLE_IMAGE_NAME</span><span class="p">)</span>
                    <span class="c1"># self.fetch_photo(index_to_set_unmapped.row())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">next_photo_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_name</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete_photo</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="c1"># TODO implement deleting thumbnails from ThumbnailStorage</span>
            <span class="c1"># self.thumbnail_storage = None</span>
            <span class="c1"># self.thumbnail_storage.initialize(self.state.storage)</span>
            <span class="c1"># self.image_list_model.initialize(self.storage.image_paths, self.thumbnail_storage, 0, self.state.storage)</span>

            <span class="k">if</span> <span class="n">next_photo_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">next_photo_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fetch_photo</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">measurements_viewer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_model</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measurements_viewer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endResetModel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_applyToUnsegmented_state</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArthropodDescriber.show_photo"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.show_photo">[docs]</a>    <span class="k">def</span> <span class="nf">show_photo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photo</span><span class="p">:</span> <span class="n">Photo</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>
        <span class="n">source_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">proxy_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapFromSource</span><span class="p">(</span><span class="n">source_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">proxy_index</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArthropodDescriber.enable_actionSave"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.enable_actionSave">[docs]</a>    <span class="k">def</span> <span class="nf">enable_actionSave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">actionSave</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_handle_label_image_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbl_img</span><span class="p">:</span> <span class="n">LabelImg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_actionSave</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_region_operation_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage</span><span class="p">:</span> <span class="n">Storage</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">label_imgs</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">LabelImg</span><span class="p">]):</span>
        <span class="n">photo</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">photo</span><span class="o">.</span><span class="n">image_path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_path</span><span class="p">:</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lab_img</span> <span class="ow">in</span> <span class="n">label_imgs</span><span class="p">:</span>
                <span class="n">photo</span><span class="p">[</span><span class="n">lab_img</span><span class="o">.</span><span class="n">label_info</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">is_segmented</span> <span class="o">=</span> <span class="n">lab_img</span><span class="o">.</span><span class="n">is_segmented</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">generate_change_command</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="p">[</span><span class="n">lab_img</span><span class="o">.</span><span class="n">label_semantic</span><span class="p">],</span> <span class="n">lab_img</span><span class="o">.</span><span class="n">label_image</span><span class="p">)</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">image_name</span> <span class="o">=</span> <span class="n">photo</span><span class="o">.</span><span class="n">image_name</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">label_name</span> <span class="o">=</span> <span class="n">lab_img</span><span class="o">.</span><span class="n">label_semantic</span>
                <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command_executor</span><span class="o">.</span><span class="n">do_commands</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">label_img_changed</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="p">[</span><span class="s1">&#39;Labels&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;setting the current photo&#39;</span><span class="p">)</span>
            <span class="c1"># self.label_editor.set_photo2(self.state.current_photo, reset_view=False)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">set_photo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_name</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lab_img</span> <span class="ow">in</span> <span class="n">label_imgs</span><span class="p">:</span>
                <span class="n">_photo</span><span class="p">[</span><span class="n">lab_img</span><span class="o">.</span><span class="n">label_semantic</span><span class="p">]</span><span class="o">.</span><span class="n">label_image</span> <span class="o">=</span> <span class="n">lab_img</span><span class="o">.</span><span class="n">label_image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">cmd_executor</span><span class="o">.</span><span class="n">undo_manager</span><span class="o">.</span><span class="n">get_undo_redo</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">clear_redo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_region_comp_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_comp</span><span class="p">:</span> <span class="n">RegionComputation</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">storage</span><span class="p">:</span> <span class="n">Storage</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">photo</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_idx</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">reg_comp</span><span class="p">(</span><span class="n">photo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">execute</span>

<div class="viewcode-block" id="ArthropodDescriber.compute_regions3"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.compute_regions3">[docs]</a>    <span class="k">def</span> <span class="nf">compute_regions3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_comp</span><span class="p">:</span> <span class="n">RegionComputation</span><span class="p">,</span> <span class="n">process_mode</span><span class="p">:</span> <span class="n">ProcessType</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">process_mode</span> <span class="o">==</span> <span class="n">ProcessType</span><span class="o">.</span><span class="n">ALL_PHOTOS</span><span class="p">:</span>
            <span class="n">img_idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_count</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">process_mode</span> <span class="o">==</span> <span class="n">ProcessType</span><span class="o">.</span><span class="n">SELECTED_PHOTOS</span><span class="p">:</span>
            <span class="n">img_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">image_list_proxy_model</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">row</span><span class="p">()</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_list</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">selectedIndexes</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img_idxs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">image_count</span><span class="p">):</span>
                <span class="n">photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_idx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">photo</span><span class="o">.</span><span class="n">has_segmentation_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">default_label_image</span><span class="p">):</span>
                    <span class="n">img_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">block_op</span> <span class="o">=</span> <span class="n">BlockingOperation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="p">,</span> <span class="n">img_idxs</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_region_comp_operation</span><span class="p">(</span><span class="n">reg_comp</span><span class="p">),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_process_region_operation_result</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">block_op</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get_photo_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="o">.</span><span class="n">image_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_applyToUnsegmented_state</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArthropodDescriber.switch_to_scale_setting"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.switch_to_scale_setting">[docs]</a>    <span class="k">def</span> <span class="nf">switch_to_scale_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># self.label_editor.disable()</span>
        <span class="c1">#</span>
        <span class="c1"># self.label_editor.image_viewer.hide()</span>
        <span class="c1"># self.label_editor.ui.photo_view.removeWidget(self.label_editor.image_viewer)</span>
        <span class="c1"># self.label_editor.ui.photo_view.insertWidget(0, self.scale_setting_widget)</span>
        <span class="c1">#</span>
        <span class="c1"># self.image_list.setItemDelegate(self.scale_thumbnail_delegate)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_image_viewer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">image_viewer</span>  <span class="c1"># TODO unify image viewer and change only the context around it</span></div>
        <span class="c1"># self.hide_thumb_gui()</span>
        <span class="c1"># self.image_list.entered.disconnect(self.show_thumbnail_gui)</span>
        <span class="c1"># self.image_list.view_left.disconnect(self.hide_thumb_gui)</span>

        <span class="c1"># self.ui.tabWidget.setTabText(0, &quot;Scale setting&quot;)</span>

<div class="viewcode-block" id="ArthropodDescriber.switch_to_label_editor"><a class="viewcode-back" href="../../arthropod_describer.html#arthropod_describer.app.ArthropodDescriber.switch_to_label_editor">[docs]</a>    <span class="k">def</span> <span class="nf">switch_to_label_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_setting_widget</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
        <span class="c1"># self.label_editor.ui.photo_view.removeWidget(self.scale_setting_widget)</span>
        <span class="c1"># self.label_editor.ui.photo_view.insertWidget(0, self.label_editor.image_viewer)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_image_viewer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span>

        <span class="c1"># self.image_list.setItemDelegate(self.thumbnail_delegate)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label_editor</span><span class="o">.</span><span class="n">image_viewer</span><span class="o">.</span><span class="n">set_photo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">current_photo</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div></div>

        <span class="c1"># self.label_editor.image_viewer.show()</span>

        <span class="c1"># self.image_list.entered.connect(self.show_thumbnail_gui)</span>
        <span class="c1"># self.image_list.view_left.connect(self.hide_thumb_gui)</span>
        <span class="c1">#</span>
        <span class="c1"># self.ui.tabWidget.setTabText(0, &quot;Label editor&quot;)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">([])</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">ArthropodDescriber</span><span class="p">()</span>
    <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, CBIA @ FI MUNI.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>